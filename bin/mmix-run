#!/bin/bash
set -eu

include_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")/../include"
src_file="$1"
shift
base_name="$(basename -s .mms "$src_file")"
preproc_file="$(mktemp "/tmp/$base_name.XXXXXXXX.c")"
obj_file="$(mktemp "/tmp/$base_name.XXXXXXXX.o")"

rm=true

cpp -D__MMIXAL -D__MMIXWARE "-I$include_dir" \
  "$src_file" -o "$preproc_file"

mmixal -b 160 -x -o "${obj_file}" "$preproc_file" \
  || (rm -f "${obj_file}" "$preproc_file" && exit 1)
rm "$preproc_file"

until [[ "$@" == "" ]]; do
  if [[ "$1" == "-mmix" ]]; then
    shift
    interpret+=( "$1" )
  else
    args+=( "$1" )
  fi
  shift
done

mmix "${interpret[@]:+${interpret[@]}}" "$obj_file" \
  "${args[@]:+${args[@]}}" || (rm -f "$obj_file" && exit 1)
rm "$obj_file"

