#!/bin/bash

#
# A small wrapper script that can be used as interpreter for .mmo files
# with the binfmt facility. Simply register this file to the binfmt service
# with a string of the form
#
#   :mmix:E::mmo::<path to binfmt-mmix>:
#
# either by piping this string directly to /proc/sys/fs/binfmt_misc/register:
#
#   echo ":mmix:E::mmo::<path to binfmt-mmix>:" >
#     /proc/sys/fs/binfmt_misc/register
#
# or by creating an entry in a configuration file /etc/binfmt.d/mmix.conf
# (or whatever name you choose).
#

set -eu

saved_state="$(stty -g)"
tty_raw_mode=false
tty_noblock=false
spawn_worker=false


#
# Query command line parameters:
#

until [[ "$@" == "" ]]; do
  if [[ "$1" == "-mmix" ]]; then
    shift
    if [[ "$1" == "-tty-raw-mode" ]]; then
      tty_raw_mode=true
    elif [[ "$1" == "-tty-noblock" ]]; then
      tty_raw_mode=true
      tty_noblock=true
    elif [[ "$1" == "-spawn-worker" ]]; then
      spawn_worker=true
    else
      interpret+=( "$1" )
    fi

  else

    args+=( "$1" )

  fi
  shift
done


#
# If possible, query binary for configuration options:
#

if command -v mmix-objdump >/dev/null 2>&1; then

  if mmix-objdump -t "${args}" | grep -q "MM:Interpreter:TTY_RAW_MODE"; then
    tty_raw_mode=true
  fi

  if mmix-objdump -t "${args}" | grep -q "MM:Interpreter:TTY_NOBLOCK"; then
    tty_noblock=true
  fi

fi


#
# Cleanup:
#

function cleanup {
  stty "${saved_state}"
}
trap cleanup EXIT


#
# Set up environment and call interpreter:
#

if $tty_raw_mode; then
  stty raw -echo
fi

if $tty_noblock; then
  stty -icanon min 0 time 0
fi

if $spawn_worker; then
  echo "not implemented"
  exit 1
fi

mmix "${interpret[@]:+${interpret[@]}}" "${args[@]:+${args[@]}}"
