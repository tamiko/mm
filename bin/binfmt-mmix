#!/bin/bash

#
# A small wrapper script that can be used as interpreter for .mmo files
# with the binfmt facility. Simply register this file to the binfmt service
# with a string of the form
#
#   :mmix:E::mmo::<path to binfmt-mmix>:
#
# either by piping this string directly to /proc/sys/fs/binfmt_misc/register:
#
#   echo ":mmix:E::mmo::<path to binfmt-mmix>:" >
#     /proc/sys/fs/binfmt_misc/register
#
# or by creating an entry in a configuration file /etc/binfmt.d/mmix.conf
# (or whatever name you choose).
#

set -eu

saved_state="$(stty -g)"

until [[ "$@" == "" ]]; do
  if [[ "$1" == "-raw-mode" ]]; then

    stty raw -echo

  elif [[ "$1" == "-raw-mode-noblock" ]]; then

    stty raw -echo min 0

  elif [[ "$1" == "-mmix" ]]; then

    shift
    interpret+=( "$1" )

  else

    args+=( "$1" )

  fi
  shift
done

mmix "${interpret[@]:+${interpret[@]}}" "${args[@]:+${args[@]}}"
stty "${saved_state}"
